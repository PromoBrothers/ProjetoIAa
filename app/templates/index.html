<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mercado Livre Scraper</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõí</text></svg>" />
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <!-- Bot√£o de toggle do modo escuro -->
    <button class="theme-toggle" id="themeToggle" title="Alternar modo escuro">
      üåô
    </button>

    <!-- Bot√£o de Logout -->
    <a href="/logout" class="btn btn-danger" style="position: fixed; top: 20px; right: 80px; z-index: 1000; padding: 10px 20px; text-decoration: none; border-radius: 8px;">
      üö™ Sair
    </a>

    <div class="container">
      <div class="header">
        <h1>üõí Mercado Livre Scraper</h1>
        <p>Encontre os melhores produtos e pre√ßos do Mercado Livre</p>
        <nav class="nav-links" style="margin-top: 15px;">
          <a href="/index" class="active">Mercado Livre</a>
          <a href="/amazon">Amazon</a>
          <a href="/whatsapp-monitor">üì± WhatsApp Monitor</a>
        </nav>
      </div>

      <div class="search-section">
        <div class="tabs">
          <button class="tab-btn active" onclick="showTab('busca', this)">
            üîç Buscar Produtos
          </button>
          <button class="tab-btn" onclick="showTab('link', this)">
            üîó Analisar Link
          </button>
          <button class="tab-btn" onclick="showTab('webhook', this)">
            üì¢ Enviar Webhook
          </button>
          <button class="tab-btn" onclick="showTab('agendamento', this)">
            üìÖ Agendamento
          </button>
          <button class="tab-btn" onclick="showTab('config', this)">
            ‚öôÔ∏è Configura√ß√µes
          </button>
        </div>

        <div id="tab-busca" class="tab-content active">
          <form class="search-form" id="searchForm">
            <div class="form-group">
              <label for="produto">Produto</label>
              <input
                type="text"
                id="produto"
                name="produto"
                placeholder="Ex: smartphone samsung"
                required
              />
            </div>
            <div class="form-group" style="flex: 0 0 150px">
              <label for="maxPages">P√°ginas</label>
              <select id="maxPages" name="maxPages">
                <option value="1">1 p√°gina</option>
                <option value="2">2 p√°ginas</option>
                <option value="3" selected>3 p√°ginas</option>
                <option value="5">5 p√°ginas</option>
              </select>
            </div>
            <div class="form-group" style="flex: 0 0 auto">
              <button type="submit" class="btn" id="searchBtn">
                Buscar Produtos
              </button>
            </div>
          </form>
        </div>

        <div id="tab-link" class="tab-content">
          <form class="search-form" id="linkForm">
            <div class="form-group">
              <label for="produtoUrl">üîó Link do Produto ou Link de Afiliado</label>
              <input
                type="url"
                id="produtoUrl"
                name="produtoUrl"
                placeholder="Cole aqui o link do produto ou seu link de afiliado do Mercado Livre..."
                required
              />
            </div>
            <div class="form-group" style="flex: 0 0 auto">
              <button type="submit" class="btn" id="linkBtn">
                Analisar Produto
              </button>
            </div>
          </form>
        </div>

        <div id="tab-webhook" class="tab-content">
          <div class="webhook-container">
            <div class="webhook-header">
              <h3>üì§ Envio em Massa para Webhook</h3>
              <p>Adicione produtos para envio autom√°tico</p>
            </div>

            <div class="webhook-input-section">
              <div class="input-methods">
                <div class="input-method active" data-method="visual">
                  <span class="method-icon">üéØ</span>
                  <span class="method-title">Modo Visual</span>
                </div>
                <div class="input-method" data-method="bulk">
                  <span class="method-icon">üìù</span>
                  <span class="method-title">Modo em Massa</span>
                </div>
              </div>

              <!-- Modo Visual -->
              <div class="input-content visual-mode active">
                <div class="add-product-card">
                  <div class="add-product-form">
                    <div class="form-row">
                      <div class="form-group" style="flex: 1;">
                        <label for="productUrl">üîó Link do Produto ou Link de Afiliado</label>
                        <input
                          type="url"
                          id="productUrl"
                          placeholder="Cole aqui o link do produto ou seu link de afiliado..."
                        />
                      </div>
                    </div>
                    <button
                      type="button"
                      class="btn add-product-btn"
                      id="addProductBtn"
                    >
                      ‚ûï Adicionar Produto
                    </button>
                  </div>
                </div>

                <div class="products-queue" id="productsQueue">
                  <div class="queue-header">
                    <h4>
                      üéØ Produtos na Fila <span class="queue-count">(0)</span>
                    </h4>
                    <button
                      type="button"
                      class="btn-secondary clear-queue-btn"
                      id="clearQueueBtn"
                    >
                      üóëÔ∏è Limpar Fila
                    </button>
                  </div>
                  <div class="queue-list" id="queueList">
                    <div class="queue-empty">
                      <span class="empty-icon">üì¶</span>
                      <p>Nenhum produto na fila</p>
                      <small>Adicione produtos usando o formul√°rio acima</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Modo em Massa -->
              <div class="input-content bulk-mode">
                <div class="bulk-input-card">
                  <label for="webhookUrls"
                    >üìù Lista de Links (Formato:
                    link_produto,link_afiliado)</label
                  >
                  <textarea
                    id="webhookUrls"
                    name="webhookUrls"
                    placeholder="Cole a lista de links aqui, um par por linha.&#10;Ex: https://produto.mercadolivre...,https://link.afiliado..."
                    rows="12"
                  ></textarea>
                  <div class="bulk-actions">
                    <button
                      type="button"
                      class="btn-secondary"
                      id="clearWebhookTextareaBtn"
                    >
                      üóëÔ∏è Limpar Lista
                    </button>
                    <button type="button" class="btn" id="importFromBulkBtn">
                      üì• Importar para Fila Visual
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="webhook-actions">
              <form id="webhookForm">
                <button
                  type="submit"
                  class="btn-primary process-webhook-btn"
                  id="webhookBtn"
                >
                  <span class="btn-icon">üöÄ</span>
                  <span class="btn-text">Processar Fila</span>
                  <span class="btn-badge" id="processCount">0</span>
                </button>
              </form>
            </div>
          </div>
        </div>
        <div id="tab-agendamento" class="tab-content">
          <div class="search-section">
            <form class="search-form" id="filtroAgendamentoForm">
              <div class="form-group">
                <label for="filtroStatus">Status</label>
                <select id="filtroStatus" name="status">
                  <option value="agendado">Agendado</option>
                  <option value="nao-agendado">N√£o Agendado</option>
                  <option value="todos">Todos</option>
                </select>
              </div>
              <div class="form-group">
                <label for="filtroOrdem">Ordenar por</label>
                <select id="filtroOrdem" name="ordem">
                  <option value="desc">Mais Recentes</option>
                  <option value="asc">Mais Antigos</option>
                </select>
              </div>
            </form>
            <div id="agendamento-list-container">
              <h3>Produtos na Base de Dados:</h3>
              <div id="agendamento-list" class="products-grid">
                <p>Carregando produtos...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Aba de Configura√ß√µes -->
        <div id="tab-config" class="tab-content">
          <div class="search-section">
            <h3>‚öôÔ∏è Configura√ß√µes do Sistema</h3>
            
            <div class="config-section">
              <h4>üìÅ Supabase Storage</h4>
              <div class="form-group">
                <label for="bucketSelector">Selecionar Bucket:</label>
                <select 
                  id="bucketSelector" 
                  onchange="trocarBucketConfig()"
                  style="
                    width: 100%; 
                    padding: 12px; 
                    border: 1px solid #ddd; 
                    border-radius: 8px; 
                    font-size: 14px;
                    background: white;
                    cursor: pointer;
                  "
                >
                  <option value="imagens_melhoradas_tech">üé® imagens_melhoradas_tech (Principal)</option>
                  <option value="imagens_melhorada">üì∑ imagens_melhorada (Alternativo)</option>
                </select>
                <small style="color: #666; margin-top: 5px; display: block;">
                  üìù Escolha qual bucket usar para carregar as imagens
                </small>
              </div>
              
              <div class="form-group">
                <label>Bucket Atual:</label>
                <div id="bucketAtualInfo" style="
                  padding: 10px;
                  background-color: #f8f9fa;
                  border: 1px solid #e1e8ed;
                  border-radius: 6px;
                  font-family: monospace;
                  color: #333;
                  font-size: 13px;
                ">
                  imagens_melhoradas_tech
                </div>
              </div>
              
              <div class="form-group">
                <label for="supabaseUrl">URL do Supabase:</label>
                <input 
                  type="text" 
                  id="supabaseUrl" 
                  placeholder="https://xxx.supabase.co"
                  value=""
                  style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                />
              </div>
              
              <button 
                type="button" 
                class="btn"
                onclick="salvarConfiguracoes()"
                style="
                  background-color: #27ae60;
                  color: white;
                  padding: 12px 24px;
                  border: none;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: 600;
                  margin-top: 10px;
                "
              >
                üíæ Salvar Configura√ß√µes
              </button>
              
              <button 
                type="button" 
                class="btn"
                onclick="testarConexao()"
                style="
                  background-color: #3498db;
                  color: white;
                  padding: 12px 24px;
                  border: none;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: 600;
                  margin-top: 10px;
                  margin-left: 10px;
                "
              >
                üß™ Testar Conex√£o
              </button>
            </div>
            
            <div class="config-status" id="configStatus" style="
              margin-top: 20px;
              padding: 15px;
              border-radius: 8px;
              display: none;
            ">
            </div>
          </div>
        </div>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Processando...</p>
        </div>
      </div>

      <div class="results-section" id="resultsSection">
        <div class="results-header">
          <div class="results-count" id="resultsCount"></div>
          <button class="clear-btn" id="clearBtn">Limpar Resultados</button>
        </div>
        <div class="products-grid" id="productsGrid"></div>
      </div>

      <div class="results-section" id="produtoSection" style="display: none">
        <div class="results-header">
          <div class="results-count">Produto Analisado</div>
          <button class="clear-btn" id="clearProdutoBtn">Limpar</button>
        </div>
        <div id="produtoDetalhado"></div>
      </div>

      <div
        class="results-section"
        id="webhookMessageSection"
        style="display: none"
      >
        <div class="results-header">
          <div class="results-count">Resposta do Webhook</div>
          <button class="clear-btn" id="clearWebhookBtn">Limpar</button>
        </div>
        <div id="webhookMessageContent"></div>
      </div>
    </div>

    <div id="agendamentoModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Agendar Envio</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="agendamentoForm">
            <input type="hidden" id="agendarProdutoId" />
            <div class="form-group">
              <label for="agendarData">Data</label>
              <input type="date" id="agendarData" required />
            </div>
            <div class="form-group">
              <label for="agendarHora">Hora</label>
              <input type="time" id="agendarHora" required />
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn">Salvar Agendamento</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="editarModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Editar Produto</h2>
          <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <div class="modal-body">
          <form id="editarForm">
            <input type="hidden" id="editarProdutoId" />
            <div class="form-group">
              <label for="editarImagemUrl">Link da Imagem</label>
              <div style="display: flex; gap: 10px; align-items: flex-end;">
                <input
                  type="url"
                  id="editarImagemUrl"
                  placeholder="https://exemplo.com/imagem.jpg"
                  oninput="updateImagePreview()"
                  style="flex: 1;"
                />
                <button
                  type="button"
                  class="btn"
                  id="buscarImagemBtn"
                  onclick="abrirSeletorImagens()"
                  style="
                    background-color: #3498db;
                    color: white;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    white-space: nowrap;
                    font-size: 14px;
                  "
                >
                  üìÅ Buscar no Bucket
                </button>
              </div>
              <small style="color: #666; margin-top: 5px; display: block">
                Cole aqui o link da imagem ou use o bot√£o para buscar no Supabase Storage
              </small>

              <!-- üî• NOVA √ÅREA PARA COLAR IMAGEM DO CLIPBOARD -->
              <div
                id="imagePasteZone"
                style="
                  margin-top: 15px;
                  border: 3px dashed #667eea;
                  border-radius: 12px;
                  padding: 30px;
                  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                  text-align: center;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  position: relative;
                  min-height: 120px;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                  justify-content: center;
                "
                onclick="focusOnPasteArea()"
              >
                <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
                <div style="font-weight: 600; color: #667eea; font-size: 16px; margin-bottom: 5px;">
                  Cole uma imagem aqui
                </div>
                <div style="color: #666; font-size: 13px;">
                  Copie uma imagem (Ctrl+C) e clique aqui para colar (Ctrl+V)
                </div>
                <input
                  type="file"
                  id="imageFileInput"
                  accept="image/*"
                  style="display: none;"
                  onchange="handleFileSelect(event)"
                />
                <button
                  type="button"
                  onclick="event.stopPropagation(); document.getElementById('imageFileInput').click();"
                  style="
                    margin-top: 15px;
                    padding: 8px 16px;
                    background: #667eea;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 13px;
                    font-weight: 500;
                  "
                >
                  üìÅ Ou escolher arquivo
                </button>
              </div>

              <div
                id="imagePreviewContainer"
                style="margin-top: 15px; text-align: center"
              >
                <div
                  id="imagePreviewLabel"
                  style="font-weight: 500; margin-bottom: 8px; color: #333"
                >
                  Preview da Imagem:
                </div>
                <div
                  id="imagePreviewWrapper"
                  style="
                    border: 2px dashed #ddd;
                    border-radius: 10px;
                    padding: 20px;
                    background-color: #fafafa;
                    min-height: 200px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                  "
                >
                  <img
                    id="imagePreview"
                    style="
                      max-width: 100%;
                      max-height: 200px;
                      border-radius: 8px;
                      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                      display: none;
                    "
                    alt="Preview da imagem"
                  />
                  <div
                    id="imagePreviewPlaceholder"
                    style="color: #999; font-style: italic"
                  >
                    üì∑ Nenhuma imagem para mostrar
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="editarMensagem">Mensagem</label>
              <textarea
                id="editarMensagem"
                rows="8"
                placeholder="Digite a mensagem personalizada para este produto..."
                style="
                  width: 100%;
                  padding: 10px;
                  font-size: 14px;
                  border-radius: 10px;
                  border: 2px solid #e1e8ed;
                  resize: vertical;
                  font-family: inherit;
                "
              ></textarea>
              <small style="color: #666; margin-top: 5px; display: block">
                Esta ser√° a mensagem enviada quando o produto for processado
              </small>
            </div>
            
            <!-- Se√ß√£o de Cupom -->
            <div class="cupom-section" style="margin-top: 20px; padding-top: 20px; border-top: 2px dashed #e1e8ed;">
              <h4 style="margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 8px;">
                üéüÔ∏è Adicionar Cupom de Desconto
              </h4>
              
              <div class="form-row" style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Primeira linha: Texto do Cupom -->
                <div class="form-group">
                  <label for="cupomTexto">Texto do Cupom</label>
                  <input
                    type="text"
                    id="cupomTexto"
                    placeholder="Ex: DESCONTO10, PROMO2024"
                    style="
                      width: 100%;
                      padding: 10px;
                      font-size: 14px;
                      border-radius: 8px;
                      border: 2px solid #e1e8ed;
                      font-family: inherit;
                      text-transform: uppercase;
                    "
                    oninput="this.value = this.value.toUpperCase(); calcularDesconto();"
                  />
                </div>
                
                <!-- Segunda linha: Tipo e Valor -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                  <div class="form-group">
                    <label for="cupomTipo">Tipo de Desconto</label>
                    <select
                      id="cupomTipo"
                      style="
                        width: 100%;
                        padding: 10px;
                        font-size: 14px;
                        border-radius: 8px;
                        border: 2px solid #e1e8ed;
                        font-family: inherit;
                        background: white;
                      "
                      onchange="alterarTipoCupom(); calcularDesconto();"
                    >
                      <option value="porcentagem">% Porcentagem</option>
                      <option value="valor">R$ Valor Fixo</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="cupomValor" id="cupomValorLabel">Desconto (%)</label>
                    <input
                      type="number"
                      id="cupomValor"
                      placeholder="10"
                      min="1"
                      step="0.01"
                      style="
                        width: 100%;
                        padding: 10px;
                        font-size: 14px;
                        border-radius: 8px;
                        border: 2px solid #e1e8ed;
                        font-family: inherit;
                      "
                      oninput="calcularDesconto();"
                    />
                  </div>
                </div>
                
                <!-- Terceira linha: Link de Afiliado -->
                <div class="form-group">
                  <label for="cupomLinkAfiliado">üîó Link de Afiliado (para usar na mensagem)</label>
                  <input
                    type="url"
                    id="cupomLinkAfiliado"
                    placeholder="https://seu-link-de-afiliado.com/produto"
                    style="
                      width: 100%;
                      padding: 10px;
                      font-size: 14px;
                      border-radius: 8px;
                      border: 2px solid #e1e8ed;
                      font-family: inherit;
                    "
                  />
                  <small style="color: #666; margin-top: 5px; display: block;">
                    Este link ser√° usado na mensagem do cupom. Se vazio, usar√° o link original do produto.
                  </small>
                </div>
                
                <button 
                  type="button" 
                  class="btn" 
                  id="aplicarCupomBtn"
                  onclick="aplicarCupom()"
                  style="
                    background-color: #ff6b6b;
                    padding: 12px 24px;
                    border-radius: 8px;
                    border: none;
                    color: white;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                    transition: all 0.3s ease;
                    width: 100%;
                  "
                >
                  üéüÔ∏è Aplicar Cupom ao Produto
                </button>
              </div>
              
              <div id="cupomPreview" style="
                margin-top: 15px;
                padding: 15px;
                background-color: #f8f9fa;
                border-radius: 8px;
                border: 1px solid #e1e8ed;
                display: none;
              ">
                <div style="font-weight: 500; margin-bottom: 8px; color: #333;">
                  üìä Preview do Desconto:
                </div>
                <div id="cupomInfo" style="font-size: 14px; color: #666;"></div>
              </div>
              
              <small style="color: #666; margin-top: 8px; display: block;">
                üí° O cupom ser√° adicionado automaticamente √† mensagem e o valor ser√° recalculado
              </small>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn-excluir"
                onclick="closeEditModal()"
              >
                Cancelar
              </button>
              <button type="submit" class="btn">Salvar Altera√ß√µes</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Seletor de Imagens do Supabase Storage -->
    <div id="seletorImagensModal" class="modal">
      <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
          <h2>üìÅ Selecionar Imagem do Bucket</h2>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            üéØ Bucket ativo: <span id="modalBucketAtivo" style="font-family: monospace; background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">carregando...</span>
          </div>
          <span class="close" onclick="fecharSeletorImagens()">&times;</span>
        </div>
        <div class="modal-body">
          <!-- Controles de busca e navega√ß√£o -->
          <div class="storage-controls" style="margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 200px;">
                <input
                  type="text"
                  id="searchImagens"
                  placeholder="üîç Buscar imagens..."
                  style="
                    width: 100%;
                    padding: 10px;
                    border: 2px solid #e1e8ed;
                    border-radius: 8px;
                    font-size: 14px;
                  "
                  oninput="buscarImagens()"
                />
              </div>
              <div style="min-width: 120px;">
                <select
                  id="bucketSelect"
                  style="
                    width: 100%;
                    padding: 10px;
                    border: 2px solid #e1e8ed;
                    border-radius: 8px;
                    font-size: 14px;
                    background: white;
                  "
                  onchange="trocarBucket()"
                >
                  <option value="imagens_melhoradas_tech">üé® imagens_melhoradas_tech</option>
                  <option value="imagens_melhorada">üì∑ imagens_melhorada</option>
                </select>
              </div>
              <button
                type="button"
                class="btn"
                onclick="carregarImagens()"
                style="
                  background-color: #27ae60;
                  color: white;
                  padding: 10px 15px;
                  border: none;
                  border-radius: 8px;
                  cursor: pointer;
                  font-size: 14px;
                "
              >
                üîÑ Atualizar
              </button>
            </div>
          </div>

          <!-- Loading para busca -->
          <div id="loadingImagens" style="display: none; text-align: center; margin: 20px;">
            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 10px; color: #666;">Carregando imagens...</p>
          </div>

          <!-- Grid de imagens -->
          <div id="imagensGrid" class="imagens-grid">
            <p style="text-align: center; color: #666; margin: 40px;">
              üì∑ Clique em "Atualizar" para carregar as imagens do bucket
            </p>
          </div>

          <!-- Pagina√ß√£o -->
          <div id="paginacaoImagens" style="display: none; margin-top: 20px; text-align: center;">
            <button id="btnAnterior" onclick="paginaAnterior()" disabled>‚óÄ Anterior</button>
            <span id="infoPagina" style="margin: 0 15px;">P√°gina 1</span>
            <button id="btnProxima" onclick="proximaPagina()">Pr√≥xima ‚ñ∂</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para Sele√ß√£o de Grupos e Envio de Mensagens -->
    <div id="modalEnviarGrupos" class="modal-envio" style="display: none;">
      <div class="modal-content-envio">
        <div class="modal-header-envio">
          <h2>üì§ Enviar Mensagem para Grupos WhatsApp</h2>
          <button class="btn-close-envio" onclick="fecharModalEnvio()">√ó</button>
        </div>

        <div class="modal-body-envio">
          <!-- Informa√ß√µes do Produto -->
          <div class="produto-preview-envio" id="produtoPreviewEnvio">
            <h3 id="produtoTituloEnvio">Carregando...</h3>
            <p id="produtoPrecoEnvio"></p>
          </div>

          <!-- Sele√ß√£o de Grupos -->
          <div class="form-group">
            <label>
              <strong>Selecione os Grupos:</strong>
              <button
                onclick="carregarGruposWhatsApp()"
                class="btn btn-secondary"
                style="float: right; padding: 5px 10px; font-size: 12px;"
                type="button"
              >
                üîÑ Atualizar
              </button>
            </label>

            <div id="listaGruposEnvio" class="lista-grupos-envio">
              <p style="text-align: center; color: #999; padding: 20px;">
                Carregando grupos...
              </p>
            </div>
          </div>

          <!-- Op√ß√µes de Envio -->
          <div class="form-group" style="margin-top: 20px;">
            <label>
              <input type="checkbox" id="enviarComImagem" checked />
              Enviar com imagem
            </label>
          </div>

          <!-- Resumo da Sele√ß√£o -->
          <div id="resumoSelecaoEnvio" class="resumo-selecao-envio" style="display: none;">
            <p style="margin: 0;">
              <strong>Grupos selecionados:</strong>
              <span id="totalGruposSelecionados">0</span>
            </p>
          </div>
        </div>

        <div class="modal-footer-envio">
          <button class="btn btn-secondary" onclick="fecharModalEnvio()" type="button">
            Cancelar
          </button>
          <button class="btn btn-primary" onclick="enviarParaGruposSelecionados()" id="btnEnviarMensagem" type="button">
            üì§ Enviar Mensagem
          </button>
        </div>
      </div>
    </div>

    <!-- Estilos do Modal de Envio -->
    <style>
      .modal-envio {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        backdrop-filter: blur(4px);
      }

      .modal-content-envio {
        background: white;
        border-radius: 16px;
        width: 90%;
        max-width: 650px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease-out;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header-envio {
        padding: 25px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .modal-header-envio h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
      }

      .modal-body-envio {
        padding: 25px;
        overflow-y: auto;
        flex: 1;
      }

      .modal-footer-envio {
        padding: 20px 25px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        background: #f8f9fa;
      }

      .btn-close-envio {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        font-size: 32px;
        cursor: pointer;
        color: white;
        padding: 0;
        width: 36px;
        height: 36px;
        line-height: 1;
        border-radius: 50%;
        transition: all 0.2s;
      }

      .btn-close-envio:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
      }

      .produto-preview-envio {
        margin-bottom: 25px;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 12px;
        border-left: 4px solid #667eea;
      }

      .produto-preview-envio h3 {
        margin: 0 0 8px 0;
        font-size: 18px;
        color: #333;
      }

      .produto-preview-envio p {
        margin: 0;
        color: #666;
        font-size: 16px;
        font-weight: 500;
      }

      .lista-grupos-envio {
        max-height: 320px;
        overflow-y: auto;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 8px;
        margin-top: 12px;
        background: #fafafa;
      }

      .grupo-item-envio {
        padding: 14px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 8px;
        margin-bottom: 4px;
      }

      .grupo-item-envio:hover {
        background: #e8eaf6;
        transform: translateX(4px);
      }

      .grupo-item-envio:last-child {
        border-bottom: none;
      }

      .grupo-item-envio input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #667eea;
      }

      .grupo-info-envio {
        flex: 1;
      }

      .grupo-nome-envio {
        font-weight: 600;
        margin-bottom: 4px;
        color: #333;
        font-size: 15px;
      }

      .grupo-participantes-envio {
        font-size: 13px;
        color: #666;
      }

      .grupo-monitorado-badge {
        background: #4caf50;
        color: white;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 8px;
      }

      .resumo-selecao-envio {
        margin-top: 20px;
        padding: 15px;
        background: #e3f2fd;
        border-radius: 10px;
        border-left: 4px solid #2196f3;
      }

      .resumo-selecao-envio p {
        margin: 0;
        color: #1976d2;
        font-size: 15px;
      }

      .resumo-selecao-envio strong {
        font-weight: 600;
      }

      /* Dark theme support */
      .dark-theme .modal-content-envio {
        background: #2c2c2c;
        color: #e0e0e0;
      }

      .dark-theme .modal-header-envio {
        border-bottom-color: #444;
      }

      .dark-theme .modal-footer-envio {
        border-top-color: #444;
        background: #252525;
      }

      .dark-theme .produto-preview-envio {
        background: #3a3a3a;
        border-left-color: #667eea;
      }

      .dark-theme .produto-preview-envio h3 {
        color: #e0e0e0;
      }

      .dark-theme .lista-grupos-envio {
        background: #333;
        border-color: #555;
      }

      .dark-theme .grupo-item-envio {
        border-bottom-color: #444;
      }

      .dark-theme .grupo-item-envio:hover {
        background: #404040;
      }

      .dark-theme .grupo-nome-envio {
        color: #e0e0e0;
      }
    </style>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
  </body>
</html>
